<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Aventura Interactiva</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background: url('https://images.unsplash.com/photo-1571506055055-a8d23aff671e?q=80&w=424&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #fff;
        }
        .container {
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }
        h1, h4 {
            text-shadow: 2px 2px 4px #000;
        }
        .turno-card {
            background-color: rgba(255, 255, 255, 0.9);
            color: #000;
            margin-top: 1rem;
            border-radius: 15px;
            padding: 1rem;
        }
        .opcion-btn {
            margin: 0.25rem;
        }
        .alert-success {
            font-weight: bold;
            text-align: center;
        }
        #historia-completa {
            white-space: pre-wrap;
            background-color: rgba(255, 255, 255, 0.9);
            color: #000;
        }
        #ultima-imagen {
            display: block;
            max-width: 100%;
            margin: 1rem auto;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-center mb-4">ðŸŒŸ Aventura Interactiva</h1>

    <!-- FORMULARIO DE INICIO -->
    <div id="form-container" class="card p-4 shadow">
        <h4 class="mb-3">Crear nueva aventura</h4>
        <div class="mb-3">
            <label class="form-label">Personaje</label>
            <input type="text" class="form-control" id="personaje" value="Lara, una exploradora curiosa">
        </div>
        <div class="mb-3">
            <label class="form-label">UbicaciÃ³n</label>
            <input type="text" class="form-control" id="ubicacion" value="un templo abandonado en la selva">
        </div>
        <div class="mb-3">
            <label class="form-label">GÃ©nero</label>
            <input type="text" class="form-control" id="genero" value="aventura">
        </div>
        <div class="mb-3">
            <label class="form-label">Cantidad de turnos</label>
            <input type="number" class="form-control" id="turnos" value="3">
        </div>
        <div class="mb-3">
            <label class="form-label">Decisiones por turno</label>
            <input type="number" class="form-control" id="decisiones" value="2">
        </div>
        <button class="btn btn-primary w-100" onclick="crearAventura()">Iniciar aventura</button>
    </div>

    <!-- HISTORIA -->
    <div id="aventura-container" class="d-none">
        <div class="turno-card shadow">
            <h5>Turno <span id="numero-turno"></span></h5>
            <p id="texto-historia"></p>
            <div id="opciones-container" class="mb-3"></div>
            <img id="ultima-imagen" class="d-none" alt="Imagen final">
        </div>
        <div class="mt-3 d-none" id="btn-historia-completa-container">
            <button class="btn btn-warning w-100" onclick="descargarHistoriaPDF()">ðŸ“œ Descargar historia completa</button>
        </div>
    </div>
</div>

<script>
    let sessionId = null;

    function procesarNegritas(texto) {
        return texto.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
    }

    async function crearAventura() {
        const request = {
            personaje: document.getElementById("personaje").value,
            ubicacion: document.getElementById("ubicacion").value,
            genero: document.getElementById("genero").value,
            cantidadTurnos: parseInt(document.getElementById("turnos").value),
            decisionesPorTurno: parseInt(document.getElementById("decisiones").value)
        };

        const resp = await fetch('/aventura', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(request)
        });

        if (!resp.ok) {
            alert("Error al crear la aventura");
            return;
        }

        const data = await resp.json();
        sessionId = data.id;
        mostrarTurno(data.primerTurno);

        document.getElementById("form-container").classList.add("d-none");
        document.getElementById("aventura-container").classList.remove("d-none");
    }

    async function avanzarTurno(opcion) {
        const resp = await fetch(`/aventura/${sessionId}/turno?opcionElegida=${opcion}`, { method: 'POST' });

        if (!resp.ok) {
            alert("Error al avanzar el turno");
            return;
        }

        const data = await resp.json();
        mostrarTurno(data);
    }

    async function mostrarUltimaImagen() {
        try {
            const resp = await fetch('/aventura/ultimaImagen');
            if (!resp.ok) return;
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const img = document.getElementById("ultima-imagen");
            img.src = url;
            img.classList.remove("d-none");
        } catch (e) {
            console.error("No se pudo cargar la Ãºltima imagen", e);
        }
    }

    function mostrarTurno(turno) {
        document.getElementById("numero-turno").innerText = turno.numero;
        document.getElementById("texto-historia").innerHTML = procesarNegritas(turno.textoHistoria);

        const opcionesContainer = document.getElementById("opciones-container");
        opcionesContainer.innerHTML = '';

        const btnHistoriaContainer = document.getElementById("btn-historia-completa-container");
        btnHistoriaContainer.classList.add("d-none");

        const ultimaImagen = document.getElementById("ultima-imagen");
        ultimaImagen.classList.add("d-none");

        if (!turno.esUltimo) {
            turno.opciones.forEach((opcion, index) => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline-primary opcion-btn";
                btn.innerText = opcion;
                btn.onclick = () => avanzarTurno(index + 1);
                opcionesContainer.appendChild(btn);
            });
        } else {
            opcionesContainer.innerHTML = '<div class="alert alert-success mt-3">ðŸŽ‰ Â¡Fin de la historia!</div>';
            btnHistoriaContainer.classList.remove("d-none");
            mostrarUltimaImagen();
        }
    }

    async function descargarHistoriaPDF() {
        const resp = await fetch(`/aventura/${sessionId}/historia`);
        const text = await resp.text();

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const margin = 15;
        const maxWidth = doc.internal.pageSize.width - (margin * 2);
        const lineHeight = 10;
        let y = margin;

        const splitText = doc.splitTextToSize(text, maxWidth);

        splitText.forEach((line) => {
            if (y + lineHeight > doc.internal.pageSize.height - margin) {
                doc.addPage();
                y = margin;
            }
            doc.text(line, margin, y);
            y += lineHeight;
        });

        doc.save("aventura_completa.pdf");
    }
</script>
</body>
</html>
